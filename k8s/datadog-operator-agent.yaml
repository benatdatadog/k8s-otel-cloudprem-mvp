---
# DatadogAgent CRD - Deploys DD Agent via Datadog Operator
# This enables OTLP receiver for logs → CloudPrem
apiVersion: datadoghq.com/v2alpha1
kind: DatadogAgent
metadata:
  name: datadog
  namespace: otel-demo
spec:
  global:
    clusterName: otel-demo
    site: datadoghq.com
    credentials:
      apiSecret:
        secretName: datadog-secrets
        keyName: api-key
    # Kubelet config for Docker Desktop
    kubelet:
      tlsVerify: false
    env:
      # CloudPrem endpoint for logs
      - name: DD_LOGS_CONFIG_LOGS_DD_URL
        value: http://cloudprem-indexer.cloudprem.svc.cluster.local:7280
      # Ensure host tags are added to logs
      - name: DD_LOGS_CONFIG_EXPECTED_TAGS_DURATION
        value: "100000"
      # Enable OTLP logs ingestion (required for OTEL → DD Agent logs)
      - name: DD_OTLP_CONFIG_LOGS_ENABLED
        value: "true"

  features:
    # Enable container log collection
    logCollection:
      enabled: true
      containerCollectAll: true

    # OTLP receiver for traces, metrics, and logs from OTEL Collector
    otlp:
      receiver:
        protocols:
          grpc:
            enabled: true
            endpoint: 0.0.0.0:4317

    # Prometheus scraping
    prometheusScrape:
      enabled: true
      enableServiceEndpoints: true

    # APM for traces
    apm:
      enabled: true

    # Infrastructure metrics - required for APM Infrastructure tab
    liveContainerCollection:
      enabled: true
    
    liveProcessCollection:
      enabled: true
    
    # Orchestrator Explorer for Kubernetes resources
    orchestratorExplorer:
      enabled: true

